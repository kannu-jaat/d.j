<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Kannu Jaat Mixing Point ‚Äî Pro DJ Mixer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://www.youtube.com/iframe_api"></script>
  <style>
    :root {
      --bg:#0f172a;--card:#1e293b;--muted:#94a3b8;--text:#fff;--bord:#334155;
      --accent:#34d399;--accent2:#60a5fa;--warn:#ef4444;--btn:#334155;--btnH:#475569;
    }
    body.day-mode {
      --bg:#f0f4f8;--card:#e2e8f0;--muted:#475569;--text:#0f172a;--bord:#cbd5e1;
      --accent:#059669;--accent2:#3b82f6;--warn:#dc2626;--btn:#cbd5e1;--btnH:#94a3b8;
    }
    *{box-sizing:border-box}
    body{
        margin:0;
        background:var(--bg);
        color:var(--text);
        font:15px/1.5 system-ui,Segoe UI,Roboto,Ubuntu,sans-serif;
        transition: background 1s cubic-bezier(.4, 0, .2, 1), color 1s cubic-bezier(.4, 0, .2, 1);
    }
    .theme-transition-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 9999;
      transform: translateY(0);
      transition: transform 1s cubic-bezier(.4, 0, .2, 1);
    }
    .theme-transition-overlay.slide-out {
      transform: translateY(100%);
    }
    h1{
      margin:20px 16px 10px;font-size:52px;font-weight:900;letter-spacing:.4px;text-align:center;
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;
      text-shadow:0 0 18px rgba(255,255,255,.25);
      animation: colorChange 28s infinite;
      background-image: linear-gradient(270deg, #ff9900, #ef4444, #60a5fa, #34d399, #ff006a, #ff0000, #fbbf24);
      background-size: 600% 100%;
    }
    @keyframes colorChange {
      0% { opacity: 0.2; background-position: 0% 50%; }
      1% { opacity: 1; }
      1% { background-image: linear-gradient(270deg, #ff9900, #ff9900); }
      3% { background-image: linear-gradient(270deg, #ef4444, #ef4444); }
      5% { background-image: linear-gradient(270deg, #60a5fa, #60a5fa); }
      7% { background-image: linear-gradient(270deg, #34d399, #34d399); }
      9% { background-image: linear-gradient(270deg, #ff006a, #ff006a); }
      11% { background-image: linear-gradient(270deg, #ff0000, #ff0000); }
      13% { background-image: linear-gradient(270deg, #fbbf24, #fbbf24); }
      14% { opacity: 1; }
      14% { background-image: linear-gradient(270deg, #ff9900, #ef4444, #60a5fa, #34d399, #ff006a, #ff0000, #fbbf24); background-position: 0% 50%; }
      28% { background-position: 100% 50%; }
      42% { background-position: 0% 50%; }
      56% { background-position: 100% 50%; }
      70% { background-position: 0% 50%; }
      84% { background-position: 100% 50%; }
      98% { background-position: 0% 50%; }
      100% { background-position: 100% 50%; }
    }
    .instagram-subtitle {
        text-align: center;
        margin: -10px auto 20px;
        color: var(--muted);
        font-size: 18px;
        overflow: hidden;
        white-space: nowrap;
        max-width: 800px;
        width: 100%;
    }
    .instagram-subtitle span.swipe {
        display: inline-block;
        animation: swipeLeftRight 10s linear infinite;
        background: linear-gradient(90deg, #feda75, #fa7e1e, #d62976, #962fbf, #4f5bd5);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    @keyframes swipeLeftRight {
        0% { transform: translateX(100%); }
        100% { transform: translateX(-100%); }
    }
    .wrap{max-width:1220px;margin:0 auto;padding:0 12px 28px}
    .main-section-bg{
      background:var(--card);
      border-top:1px solid var(--bord);
      border-bottom:1px solid var(--bord);
      padding: 1px 5px 5px;
    }
    .topbar{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;padding:10px;border-radius:12px;margin:12px 12px 12px;
      justify-content: space-between;
    }
    .search-and-suggest {
      position: relative;
      flex: 1;
      min-width: 220px;
      z-index: 10;
    }
    .search-and-suggest input[type="text"]{
      width:100%;background:var(--bg);border:1px solid var(--bord);color:var(--text);
      padding:10px 12px;border-radius:10px;outline:none;
    }
    .btn{background:var(--btn);color:var(--text);border:none;border-radius:10px;padding:10px 14px;cursor:pointer;transition:background .2s}
    .btn:hover{background:var(--btnH)}
    .btn.primary{background:linear-gradient(90deg,var(--accent2),var(--accent));color:#06121a;font-weight:800}
    #suggestions{
      position: absolute;top: calc(100% + 4px);left: 0;right: 0;z-index: 10;
      background:var(--card);border:1px solid var(--bord);border-radius:12px;
      box-shadow:0 8px 16px rgba(0,0,0,.2);
      max-height:140px;overflow-y:auto;
      display:none;
    }
    .suggestion-item{
      padding:10px 12px;cursor:pointer;
      border-bottom:1px solid var(--bord);
    }
    .suggestion-item:last-child{border-bottom:none;}
    .suggestion-item:hover{background:var(--btnH);}
    .resultsWrap{
      margin:0 12px 16px; border:1px solid var(--bord); background:var(--bg);
      border-radius:12px; padding:10px;
    }
    .results{
      max-height:260px; overflow-y:auto;
      display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:10px;
    }
    .card{
      background:var(--bg);border:1px solid var(--bord);border-radius:12px;overflow:hidden;display:flex;flex-direction:column;
      position: relative; min-height: 250px;
    }
    .card .thumb-wrapper {
      position: relative; width: 100%; aspect-ratio: 16/9; flex-shrink: 0;
    }
    .card .thumb-wrapper img {
      width: 100%; height: 100%; object-fit: cover; background: #000;
    }
    .card .meta{padding:8px 10px; flex-grow: 1;}
    .card h4{font-size:14px;margin:0 0 6px; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;}
    .card .small{color:var(--muted);font-size:12px}
    .card .actions{display:flex;gap:6px;padding:8px 10px 10px;flex-wrap:wrap; margin-top:auto; position: relative; z-index: 5;}
    .duration-badge{
      position:absolute;bottom:6px;right:6px;
      background:rgba(0,0,0,0.8);color:#fff;
      font-size:11px;padding:2px 5px;border-radius:4px;
      font-weight:600;
      pointer-events: none;
    }
    .decks-container{
        display:flex;justify-content:center;gap:16px;margin:0 12px;flex-wrap:wrap
    }
    .deck{padding:12px;position:relative;flex:1;min-width:300px;max-width:500px}
    .deck h3{margin:4px 0 10px;font-size:16px}
    .row{display:flex;gap:8px;align-items:center;margin-bottom:10px}
    .row input[type="text"], .row select {
        flex: 1;
        min-width: 100px;
        background: var(--bg);
        border: 1px solid var(--bord);
        color: var(--text);
        padding: 8px 10px;
        border-radius: 10px;
        outline: none;
        appearance: none;
        -webkit-appearance: none;
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>');
        background-repeat: no-repeat;
        background-position: right 8px center;
        cursor: pointer;
    }
    .players-and-meters-row{
      display:flex;align-items:center;gap:10px;margin-bottom:12px;
    }
    .ifwrap{flex:1;position:relative}
    iframe{width:100%;height:300px;border:0;border-radius:12px;background:var(--bg)}
    .warning{
      position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
      background:rgba(15,23,42,.88);border:2px dashed var(--warn);border-radius:12px;
      color:var(--warn);font-weight:900;font-size:14px;padding:10px;text-align:center
    }
    .local-audio-deck {
      background: #111a2e;
      border: 1px solid var(--bord);
      border-radius: 12px;
      padding: 16px;
      height: 300px;
      position: relative;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      transition: all 0.2s ease-in-out;
    }
    body.day-mode .local-audio-deck {
        background: var(--card);
    }
    .local-audio-deck h4 { margin-top: 0; font-size: 16px; text-align: left; width: 100%; }
    .local-audio-deck .file-name-container {
      display: flex; align-items: center; width: 100%; background: var(--btn); border-radius: 8px; padding: 8px 12px; gap: 10px; cursor: pointer;
    }
    .local-audio-deck .file-name { color: var(--muted); flex: 1; text-align: left; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .local-audio-deck input[type="file"] { display: none; }
    .local-audio-deck .file-picker-btn { background: var(--btnH); color: var(--text); padding: 6px 10px; border-radius: 6px; font-size: 12px; white-space: nowrap; }
    .local-audio-deck .playback-container { width: 100%; margin-top: 20px; text-align: center; }
    .local-audio-deck .playback-row { display: flex; align-items: center; gap: 10px; padding: 0 5px; }
    .local-audio-deck .playback-row .time-display { font-size: 14px; color: var(--accent); width: 50px; text-align: right; }
    .local-audio-deck .playback-row .duration-display { font-size: 14px; color: var(--muted); width: 50px; text-align: left; }
    .local-audio-deck .playback-row input[type="range"] {
      flex: 1; height: 6px; -webkit-appearance: none; background: #444; border-radius: 5px; cursor: pointer; margin: 0;
    }
    .local-audio-deck .playback-row input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none; width: 14px; height: 14px; background: var(--accent); border-radius: 50%; cursor: pointer;
    }
    .local-audio-deck .controls-row { display: flex; justify-content: center; gap: 6px; margin-top: 20px; flex-wrap: wrap; }
    .local-audio-deck .control-btn {
      background: var(--btnH); color: var(--text); font-size: 12px; padding: 6px 10px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold;
    }
    .local-audio-deck .control-btn:hover { background: var(--accent); color: #000; }
    .meter-container{display:flex;gap:2px}
    .meter{
      width:28px;height:300px;border-radius:8px;border:1px solid rgba(255,255,255,.15);
      padding:3px;display:flex;flex-direction:column-reverse;gap:3px;background:rgba(255,255,255,.04)
    }
    .seg{flex:1;border:1px solid var(--muted);border-radius:3px;transition:all .15s}
    .on{border:none}
    .c1{background:#34d399}.c2{background:#60a5fa}.c3{background:#fbbf24}.c4{background:#ef4444}
    .blink-fast{animation:bl .22s infinite alternate}
    @keyframes bl{from{opacity:1}to{opacity:.4}}
    .xfwrap{margin:18px 12px;padding:12px;border-radius:12px}
    .xfrow{display:flex;gap:12px;align-items:center}
    .xfrow input[type="range"]{flex:1;height:10px;border-radius:8px;background:linear-gradient(90deg,var(--accent2),var(--accent));-webkit-appearance:none}
    .xfrow input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:22px;height:22px;background:#fff;border-radius:50%;border:4px solid var(--bg);box-shadow:0 0 8px rgba(0,0,0,.5)}
    .lab{width:44px;text-align:center;color:var(--muted);font-weight:700}
    .live-info { display: flex; flex-direction: column; align-items: flex-end; min-width: 150px; }
    .live-info .date-display { color: var(--muted); font-size: 14px; }
    .live-info .time-display { font-size: 20px; font-weight: bold; color: var(--accent); }
    .list-section{margin:12px;padding:10px;border-radius:12px}
    .list-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    #playlistBox { max-height: 280px; overflow-y: auto; padding-right: 12px; }
    #playlistBox::-webkit-scrollbar { width: 8px; }
    #playlistBox::-webkit-scrollbar-track { background: var(--card); border-radius: 10px; }
    #playlistBox::-webkit-scrollbar-thumb { background: var(--btnH); border-radius: 10px; }
    .pl-item{
      display:flex;gap:10px;align-items:center;justify-content:space-between;
      background:var(--bg);border:1px solid var(--bord);border-radius:10px;padding:8px 10px;margin:6px 0; cursor:pointer;
    }
    .pl-item:hover{background:var(--btnH);}
    .pl-title{flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    #settingsContainer {
        display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.85); z-index: 1000; backdrop-filter: blur(5px); align-items: center; justify-content: center;
    }
    #settingsBox {
        background: var(--card); padding: 24px; border-radius: 12px; border: 1px solid var(--bord); width: 90%; max-width: 500px; box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
    }
    #settingsBox h2 { margin-top: 0; font-size: 24px; color: var(--accent2); text-align: center; }
    #apiKeyInput { width: 100%; background: var(--bg); border: 1px solid var(--bord); color: var(--text); padding: 10px 12px; border-radius: 10px; outline: none; margin-bottom: 10px; }
    #apiKeySaveBtn, #settingsCloseBtn { width: 100%; margin-top: 10px; }
    
    #relatedVideosSection { margin: 12px; padding: 10px; border-radius: 12px; }
    #relatedVideosGrid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 12px;
      padding: 10px;
      height: 350px; 
      overflow-y: auto; 
      background: var(--bg);
      border: 1px solid var(--bord);
      border-radius: 12px;
      align-content: start;
    }
    #relatedVideosGrid::-webkit-scrollbar { width: 8px; }
    #relatedVideosGrid::-webkit-scrollbar-track { background: transparent; }
    #relatedVideosGrid::-webkit-scrollbar-thumb { background: var(--btnH); border-radius: 10px; }
    #relatedVideosGrid .card { background: var(--bg); }
    #relatedVideosGrid .card:hover { background: var(--btnH); }
    
    .fade-speed-row {
      display: flex; align-items: center; gap: 8px; margin-right: 15px; color: var(--muted); font-size: 13px;
    }
    #fadeSpeed {
      background: var(--bg); border: 1px solid var(--bord); color: var(--text); padding: 4px 8px; border-radius: 6px; outline: none;
    }
  </style>
</head>
<body>
  <div id="settingsContainer">
    <div id="settingsBox">
      <h2>API Key Settings</h2>
      <p style="font-size:14px;color:var(--muted);text-align:center">‡§Ö‡§™‡§®‡•Ä YouTube Data API v3 Key ‡§Ø‡§π‡§æ‡§Ç ‡§°‡§æ‡§≤‡•á‡§Ç‡•§</p>
      <input type="text" id="apiKeyInput" placeholder="Enter your API Key here...">
      <button class="btn primary" id="apiKeySaveBtn">Save Key</button>
      <button class="btn" id="settingsCloseBtn">Close</button>
    </div>
  </div>
  
  <div class="wrap">
    <h1>üéß Kannu Jaat Mixing Point üé∂</h1>
    <div class="instagram-subtitle"><span class="swipe">üî∏ IG‚Üí @kannu_jaat_03</span></div>
  </div>
  <div class="main-section-bg">
    <div class="topbar">
      <div class="search-and-suggest">
        <input id="searchInput" type="text" placeholder="Search YouTube‚Ä¶ (e.g. 'lofi hip hop', 'Arijit live')" autocomplete="off" />
        <div id="suggestions"></div>
      </div>
      <button class="btn primary" id="searchBtn">Search</button>
      <button class="btn" id="clearSearchBtn">‚ùå</button>
      <button class="btn" id="themeToggleBtn">‚òÄÔ∏è</button>
      <button class="btn" id="openSettingsBtn">‚öôÔ∏è</button>
      <div class="live-info">
        <span class="time-display" id="liveTime"></span>
        <span class="date-display" id="liveDate"></span>
      </div>
    </div>
    
    <div class="resultsWrap">
      <div id="results" class="results"></div>
    </div>
    
    <div id="relatedVideosSection" class="list-section">
      <div class="list-header">
        <h3>Related Music <small style="color:var(--muted)">(Smart Recommendations)</small></h3>
        <button class="btn" id="relatedToggleBtn" style="font-weight:bold; color:var(--accent);">Auto-Fetch: ON</button>
      </div>
      <div id="relatedVideosGrid"></div>
    </div>

    <div class="players-and-meters-row">
        <div class="deck" id="leftDeck">
          <h3>Left YouTube Deck</h3>
          <div class="row">
              <input id="leftUrl" type="text" placeholder="Paste YouTube URL or ID" />
              <button class="btn" onclick="clearUrl('left')">‚ùå</button>
              <button class="btn" onclick="loadFromUrl('left')">Load</button>
          </div>
          <div class="row" style="margin-bottom: 0;">
              <label for="leftQuality" style="color: var(--muted); font-size: 14px;">Quality:</label>
              <select id="leftQuality">
                  <option value="auto">Auto</option>
                  <option value="hd1080">1080p</option>
                  <option value="hd720">720p</option>
                  <option value="medium">360p</option>
              </select>
          </div>
          <div class="ifwrap">
            <div id="leftPlayer"></div>
            <div id="leftWarn" class="warning" style="display:none;"></div>
          </div>
          <div class="row" style="flex-wrap:wrap;gap:8px;margin-top:12px">
            <button class="btn" onclick="playDeck('left')">‚ñ∂Ô∏è</button>
            <button class="btn" onclick="pauseDeck('left')">‚è∏Ô∏è</button>
            <button class="btn" onclick="seekDeck('left',-10)">‚è™ -10s</button>
            <button class="btn" onclick="seekDeck('left',10)">‚è© +10s</button>
          </div>
        </div>
        <div class="meter-container">
          <div class="meter" id="leftMeter">
            <div class="seg"></div><div class="seg"></div><div class="seg"></div><div class="seg"></div><div class="seg"></div>
            <div class="seg"></div><div class="seg"></div><div class="seg"></div><div class="seg"></div><div class="seg"></div>
          </div>
          <div class="meter" id="rightMeter">
            <div class="seg"></div><div class="seg"></div><div class="seg"></div><div class="seg"></div><div class="seg"></div>
            <div class="seg"></div><div class="seg"></div><div class="seg"></div><div class="seg"></div><div class="seg"></div>
          </div>
        </div>
        <div class="deck" id="rightDeck">
          <h3>Right YouTube Deck</h3>
          <div class="row">
            <input id="rightUrl" type="text" placeholder="Paste YouTube URL or ID" />
            <button class="btn" onclick="clearUrl('right')">‚ùå</button>
            <button class="btn" onclick="loadFromUrl('right')">Load</button>
          </div>
          <div class="row" style="margin-bottom: 0;">
              <label for="rightQuality" style="color: var(--muted); font-size: 14px;">Quality:</label>
              <select id="rightQuality">
                  <option value="auto">Auto</option>
                  <option value="hd1080">1080p</option>
                  <option value="hd720">720p</option>
                  <option value="medium">360p</option>
              </select>
          </div>
          <div class="ifwrap">
            <div id="rightPlayer"></div>
            <div id="rightWarn" class="warning" style="display:none;"></div>
          </div>
          <div class="row" style="flex-wrap:wrap;gap:8px;margin-top:12px">
            <button class="btn" onclick="playDeck('right')">‚ñ∂Ô∏è</button>
            <button class="btn" onclick="pauseDeck('right')">‚è∏Ô∏è</button>
            <button class="btn" onclick="seekDeck('right',-10)">‚è™ -10s</button>
            <button class="btn" onclick="seekDeck('right',10)">‚è© +10s</button>
          </div>
        </div>
    </div>
    <div class="xfwrap">
      <div class="xfrow">
        <div class="lab">Left</div>
        <input id="xfader" type="range" min="0" max="100" value="50" />
        <div class="lab">Right</div>
      </div>
      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <div class="fade-speed-row">
          Speed:
          <select id="fadeSpeed">
            <option value="0">0s</option>
            <option value="0.5">0.5s</option>
            <option value="1" selected>1s</option>
            <option value="2">2s</option>
            <option value="3">3s</option>
          </select>
        </div>
        <button class="btn" onclick="fadeTo(0)">Fade Left ‚¨ÖÔ∏è</button>
        <button class="btn" onclick="fadeTo(100)">Fade Right ‚û°Ô∏è</button>
        <button class="btn primary" onclick="playBoth()">Play Both</button>
        <button class="btn" onclick="pauseBoth()">Pause Both</button>
      </div>
    </div>
    <div class="players-and-meters-row">
      <div class="deck">
        <h3>Local Deck A</h3>
        <div id="localDeckA" class="local-audio-deck">
          <input type="file" id="fileInputA" accept="audio/*">
          <div class="file-name-container">
            <label for="fileInputA" class="file-picker-btn">Choose File</label>
            <p class="file-name" id="fileNameA">No file chosen</p>
          </div>
          <div class="playback-container">
            <div class="playback-row">
              <span class="time-display" id="currentTimeA">0:00</span>
              <input type="range" id="seekA" value="0" step="1" min="0" max="100">
              <span class="duration-display" id="durationA">0:00</span>
            </div>
            <div class="controls-row">
              <button class="control-btn" id="playBtnA" onclick="playLocal('A')">Play</button>
              <button class="control-btn" id="pauseBtnA" onclick="pauseLocal('A')" style="display:none;">Pause</button>
              <button class="control-btn" onclick="seekLocal('A', -10)">-10s</button>
              <button class="control-btn" onclick="seekLocal('A', 10)">+10s</button>
              <button class="control-btn" onclick="stopLocal('A')">Stop</button>
            </div>
          </div>
        </div>
      </div>
      <div class="meter-container">
        <div class="meter" id="localMeterA">
            <div class="seg"></div><div class="seg"></div><div class="seg"></div><div class="seg"></div><div class="seg"></div>
            <div class="seg"></div><div class="seg"></div><div class="seg"></div><div class="seg"></div><div class="seg"></div>
        </div>
        <div class="meter" id="localMeterB">
            <div class="seg"></div><div class="seg"></div><div class="seg"></div><div class="seg"></div><div class="seg"></div>
            <div class="seg"></div><div class="seg"></div><div class="seg"></div><div class="seg"></div><div class="seg"></div>
        </div>
      </div>
      <div class="deck">
        <h3>Local Deck B</h3>
        <div id="localDeckB" class="local-audio-deck">
          <input type="file" id="fileInputB" accept="audio/*">
          <div class="file-name-container">
            <label for="fileInputB" class="file-picker-btn">Choose File</label>
            <p class="file-name" id="fileNameB">No file chosen</p>
          </div>
          <div class="playback-container">
            <div class="playback-row">
              <span class="time-display" id="currentTimeB">0:00</span>
              <input type="range" id="seekB" value="0" step="1" min="0" max="100">
              <span class="duration-display" id="durationB">0:00</span>
            </div>
            <div class="controls-row">
              <button class="control-btn" id="playBtnB" onclick="playLocal('B')">Play</button>
              <button class="control-btn" id="pauseBtnB" onclick="pauseLocal('B')" style="display:none;">Pause</button>
              <button class="control-btn" onclick="seekLocal('B', -10)">-10s</button>
              <button class="control-btn" onclick="seekLocal('B', 10)">+10s</button>
              <button class="control-btn" onclick="stopLocal('B')">Stop</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="list-section">
      <div class="list-header">
        <h3>Playlist</h3>
      </div>
      <div id="playlistBox"></div>
    </div>
  </div>
<script>
const API_KEY_STORAGE_KEY = "youtubeApiKeys";
let players = { left:null, right:null };
let localPlayers = { A: new Audio(), B: new Audio() };
let playlist = []; 
let apiKeys = [];
let renderedRelatedIds = new Set();
let showingDefaultMusic = false;
let autoFetchRelated = true; 
let fadeInterval = null;

const themeToggleBtn = document.getElementById('themeToggleBtn');
const body = document.body;
const root = document.documentElement;
const THEMES = {
  'night-mode': { '--bg':'#0f172a','--card':'#1e293b','--muted':'#94a3b8','--text':'#fff','--bord':'#334155','--accent':'#34d399','--accent2':'#60a5fa','--warn':'#ef4444','--btn':'#334155','--btnH':'#475569' },
  'day-mode': { '--bg':'#f0f4f8','--card':'#e2e8f0','--muted':'#475569','--text':'#0f172a','--bord':'#cbd5e1','--accent':'#059669','--accent2':'#3b82f6','--warn':'#dc2626','--btn':'#cbd5e1','--btnH':'#94a3b8' }
};
function applyTheme(themeName) {
  const theme = THEMES[themeName];
  if (!theme) return;
  for (const [key, value] of Object.entries(theme)) root.style.setProperty(key, value);
  body.classList.remove('night-mode', 'day-mode');
  body.classList.add(themeName);
  localStorage.setItem('theme', themeName);
  themeToggleBtn.textContent = (themeName === 'night-mode') ? '‚òÄÔ∏è' : 'üåô';
}
themeToggleBtn.addEventListener('click', () => {
  const newTheme = body.classList.contains('day-mode') ? 'night-mode' : 'day-mode';
  applyTheme(newTheme);
});
applyTheme(localStorage.getItem('theme') || 'night-mode');

const openSettingsBtn = document.getElementById('openSettingsBtn');
const settingsContainer = document.getElementById('settingsContainer');
const settingsCloseBtn = document.getElementById('settingsCloseBtn');
const apiKeyInput = document.getElementById('apiKeyInput');
const apiKeySaveBtn = document.getElementById('apiKeySaveBtn');

function loadApiKeys() {
  try {
    const keys = JSON.parse(localStorage.getItem(API_KEY_STORAGE_KEY));
    if (Array.isArray(keys) && keys.length > 0) {
        apiKeys = keys;
        setTimeout(() => fetchRelatedVideosFromPlaylist(), 1000); 
    } else openSettingsBtn.click();
  } catch (e) { openSettingsBtn.click(); }
}
apiKeySaveBtn.addEventListener('click', () => {
  const keys = apiKeyInput.value.split(',').map(key => key.trim()).filter(key => key.length > 0);
  if (keys.length > 0) {
    localStorage.setItem(API_KEY_STORAGE_KEY, JSON.stringify(keys));
    apiKeys = keys; 
    settingsContainer.style.display = 'none';
    fetchRelatedVideosFromPlaylist();
  } else alert('Please enter valid API Key.');
});
openSettingsBtn.addEventListener('click', () => { apiKeyInput.value = apiKeys.join(', '); settingsContainer.style.display = 'flex'; });
settingsCloseBtn.addEventListener('click', () => { settingsContainer.style.display = 'none'; });
window.addEventListener('load', loadApiKeys);

setInterval(() => {
    const now = new Date();
    document.getElementById('liveTime').textContent = now.toTimeString().split(' ')[0];
    document.getElementById('liveDate').textContent = `${String(now.getDate()).padStart(2,'0')}-${String(now.getMonth()+1).padStart(2,'0')}-${now.getFullYear()}`;
}, 1000);

async function getSuggestions(q) {
  if (!q) return;
  const script = document.createElement('script');
  script.src = `https://suggestqueries.google.com/complete/search?client=youtube&ds=yt&q=${encodeURIComponent(q)}&callback=handleSuggestions`;
  document.head.appendChild(script);
  document.head.removeChild(script);
}
window.handleSuggestions = (data) => {
  if (data && data[1]) renderSuggestions(data[1].map(item => item[0]));
};

function onYouTubeIframeAPIReady(){
  players.left = new YT.Player('leftPlayer',{ height:'300',width:'100%',playerVars:{controls:1,rel:0,iv_load_policy:3,modestbranding:1}, events:{'onStateChange': (e)=>handleState('left',e)} });
  players.right = new YT.Player('rightPlayer',{ height:'300',width:'100%',playerVars:{controls:1,rel:0,iv_load_policy:3,modestbranding:1}, events:{'onStateChange': (e)=>handleState('right',e)} });
  document.getElementById('leftUrl').addEventListener('input', debounce(() => loadFromUrl('left'), 500));
  document.getElementById('rightUrl').addEventListener('input', debounce(() => loadFromUrl('right'), 500));
  setupLocalLoaders(); applyCrossfader();
}

async function handleState(side, e) {
  if (e.data === YT.PlayerState.PLAYING) {
    const videoData = players[side].getVideoData();
    if (videoData.video_id && !playlist.find(x => x.id === videoData.video_id)) {
      if(apiKeys.length > 0) {
        try {
          const res = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet,contentDetails&id=${videoData.video_id}&key=${apiKeys[0]}`);
          const data = await res.json();
          const it = data.items[0];
          addToPlaylist({ id: videoData.video_id, title: it.snippet.title, thumb: it.snippet.thumbnails.default.url });
        } catch(err) {}
      }
    }
  }
}

function debounce(func, delay) { let timeout; return function(...args) { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), delay); }; }
function getIdFromUrl(u){ if(!u) return ""; if(/^[a-zA-Z0-9_-]{11}$/.test(u)) return u; try{ const url=new URL(u.trim()); if(url.hostname.includes('youtu.be')) return url.pathname.slice(1); if(url.searchParams.get('v')) return url.searchParams.get('v'); }catch{} return ""; }
function formatTime(s){ if (isNaN(s)) return '0:00'; const m = Math.floor(s/60), sec = Math.floor(s%60); return `${m}:${sec < 10 ? '0' : ''}${sec}`; }
function parseDuration(duration) {
    if (!duration) return "";
    const match = duration.match(/PT(\d+H)?(\d+M)?(\d+S)?/);
    if (!match) return "";
    const hours = (parseInt(match[1]) || 0);
    const minutes = (parseInt(match[2]) || 0);
    const seconds = (parseInt(match[3]) || 0);
    let res = "";
    if (hours > 0) res += hours + ":" + String(minutes).padStart(2, '0') + ":";
    else res += minutes + ":";
    res += String(seconds).padStart(2, '0');
    return res;
}
function escapeHtml(s){ return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

function loadFromUrl(side){
  const id = getIdFromUrl(document.getElementById(side+'Url').value);
  if(id) players[side].cueVideoById({ videoId: id, suggestedQuality: document.getElementById(side+'Quality').value });
}
function cueToDeck(side,id){ players[side].cueVideoById({ videoId: id, suggestedQuality: document.getElementById(side+'Quality').value }); }
function playDeck(side){ players[side].playVideo(); }
function pauseDeck(side){ players[side].pauseVideo(); }
function seekDeck(side,secs){ players[side].seekTo(Math.max(0, players[side].getCurrentTime()+secs),true); }
function playBoth(){ playDeck('left'); playDeck('right'); playLocal('A'); playLocal('B'); }
function pauseBoth(){ pauseDeck('left'); pauseDeck('right'); pauseLocal('A'); pauseLocal('B'); }
function clearUrl(side){ document.getElementById(side+'Url').value = ''; }

function fadeTo(target) {
  const xf = document.getElementById('xfader');
  const speed = parseFloat(document.getElementById('fadeSpeed').value);
  const start = parseInt(xf.value);
  const diff = target - start;

  if (fadeInterval) clearInterval(fadeInterval);
  if (speed === 0 || diff === 0) {
    xf.value = target;
    applyCrossfader();
    return;
  }

  const steps = 40;
  const stepTime = (speed * 1000) / steps;
  const stepVal = diff / steps;
  let count = 0;

  fadeInterval = setInterval(() => {
    count++;
    xf.value = start + (stepVal * count);
    applyCrossfader();
    if (count >= steps) {
      xf.value = target;
      applyCrossfader();
      clearInterval(fadeInterval);
    }
  }, stepTime);
}

function setupLocalLoaders() {
  ['A', 'B'].forEach(side => {
    const input = document.getElementById(`fileInput${side}`), player = localPlayers[side];
    input.addEventListener('change', (e) => {
        if(e.target.files[0]) {
            if(player.src) URL.revokeObjectURL(player.src);
            player.src = URL.createObjectURL(e.target.files[0]);
            document.getElementById(`fileName${side}`).textContent = e.target.files[0].name;
        }
    });
    player.addEventListener('loadedmetadata', () => { document.getElementById(`duration${side}`).textContent = formatTime(player.duration); document.getElementById(`seek${side}`).max = player.duration; });
    player.addEventListener('timeupdate', () => { const seek = document.getElementById(`seek${side}`); document.getElementById(`currentTime${side}`).textContent = formatTime(player.currentTime); if(!seek.isDragging) seek.value = player.currentTime; });
    document.getElementById(`seek${side}`).addEventListener('input', (e) => { e.target.isDragging=true; document.getElementById(`currentTime${side}`).textContent = formatTime(e.target.value); });
    document.getElementById(`seek${side}`).addEventListener('change', (e) => { player.currentTime = e.target.value; e.target.isDragging=false; });
  });
}
function playLocal(side) { if(localPlayers[side].src) { localPlayers[side].play(); document.getElementById(`playBtn${side}`).style.display='none'; document.getElementById(`pauseBtn${side}`).style.display='block'; } }
function pauseLocal(side) { localPlayers[side].pause(); document.getElementById(`playBtn${side}`).style.display='block'; document.getElementById(`pauseBtn${side}`).style.display='none'; }
function seekLocal(side, secs) { if(localPlayers[side].src) { localPlayers[side].currentTime = Math.max(0, Math.min(localPlayers[side].duration, localPlayers[side].currentTime + secs)); } }
function stopLocal(side) { pauseLocal(side); localPlayers[side].currentTime = 0; }

const xf = document.getElementById('xfader');
xf.addEventListener('input', applyCrossfader);
function applyCrossfader(){
  const v = parseInt(xf.value,10), L = 100-v, R = v;
  try{ players.left.setVolume(L); players.right.setVolume(R); }catch{}
  localPlayers.A.volume = L/100; localPlayers.B.volume = R/100;
}

setInterval(() => {
    const v = parseInt(xf.value,10), L = 100-v, R = v;
    let lOn = false, rOn = false, laOn = false, lbOn = false;
    try{ const sl = players.left.getPlayerState(); lOn = (sl===1||sl===3); }catch{}
    try{ const sr = players.right.getPlayerState(); rOn = (sr===1||sr===3); }catch{}
    if(!localPlayers.A.paused && localPlayers.A.src) laOn = true;
    if(!localPlayers.B.paused && localPlayers.B.src) lbOn = true;
    
    function paint(segs, lit) { 
      segs.forEach((s,i)=>{ 
        s.className='seg'; 
        if(i<lit){ 
          s.classList.add('on', i<3?'c1':i<6?'c2':i<9?'c3':'c4'); 
          if(i >= 7) s.classList.add('blink-fast');
        } 
      }); 
    }
    paint(Array.from(document.querySelectorAll('#leftMeter .seg')), (lOn || laOn) ? Math.round(L/10) : 0);
    paint(Array.from(document.querySelectorAll('#rightMeter .seg')), (rOn || lbOn) ? Math.round(R/10) : 0);
    paint(Array.from(document.querySelectorAll('#localMeterA .seg')), laOn ? Math.round(L/10) : 0);
    paint(Array.from(document.querySelectorAll('#localMeterB .seg')), lbOn ? Math.round(R/10) : 0);
}, 160);

const searchInput = document.getElementById('searchInput');
const suggestionsEl = document.getElementById('suggestions');
const clearSearchBtn = document.getElementById('clearSearchBtn');

// Fix for Search Clear Button
clearSearchBtn.addEventListener('click', () => {
  searchInput.value = '';
  suggestionsEl.style.display = 'none';
  document.getElementById('results').innerHTML = '';
});

searchInput.addEventListener('input', debounce(() => { const q = searchInput.value.trim(); if(q) getSuggestions(q); else suggestionsEl.style.display='none'; }, 300));
document.getElementById('searchBtn').addEventListener('click', doSearch);
searchInput.addEventListener('keydown', (e)=> e.key==='Enter' && doSearch());

async function doSearch(){
  const q = searchInput.value.trim();
  if(!q) return;
  const resultsEl = document.getElementById('results');
  resultsEl.innerHTML = 'Searching...';
  suggestionsEl.style.display = 'none';
  
  if(apiKeys.length > 0) {
      const res = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=15&q=${encodeURIComponent(q)}&key=${apiKeys[0]}`);
      const data = await res.json();
      if(data.items) {
          const videoIds = data.items.map(it => it.id.videoId).join(',');
          const vRes = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet,contentDetails&id=${videoIds}&key=${apiKeys[0]}`);
          const vData = await vRes.json();
          renderResults(vData.items);
      }
  }
}
function renderResults(items){
  const resEl = document.getElementById('results');
  resEl.innerHTML = '';
  items.forEach(it => {
    const sn = it.snippet, id = it.id;
    const card = document.createElement('div'); card.className='card';
    card.innerHTML = `
      <div class="thumb-wrapper">
        <img src="${sn.thumbnails.medium.url}">
        <div class="duration-badge">${parseDuration(it.contentDetails.duration)}</div>
      </div>
      <div class="meta"><h4>${escapeHtml(sn.title)}</h4><div class="small">${sn.channelTitle}</div></div>
      <div class="actions"><button class="btn" onclick="cueToDeck('left','${id}')">Left</button><button class="btn" onclick="cueToDeck('right','${id}')">Right</button>
      <button class="btn" onclick="addToPlaylist({id:'${id}',title:\`${escapeHtml(sn.title)}\`})">+ Playlist</button></div>`;
    resEl.appendChild(card);
  });
}
function renderSuggestions(list) {
  suggestionsEl.innerHTML = '';
  if(!list.length) { suggestionsEl.style.display='none'; return; }
  list.forEach(s => {
    const div = document.createElement('div'); div.className='suggestion-item'; div.textContent=s;
    div.onclick=()=>{ searchInput.value=s; doSearch(); }; suggestionsEl.appendChild(div);
  });
  suggestionsEl.style.display='block';
}

function addToPlaylist(item){
  if(!playlist.find(x=>x.id===item.id)) {
      playlist.unshift(item);
      renderPlaylist();
      fetchRelatedVideosFromPlaylist(); 
  }
}
function renderPlaylist(){
  const box = document.getElementById('playlistBox'); box.innerHTML = '';
  playlist.forEach(it => {
    const row = document.createElement('div'); row.className='pl-item';
    row.innerHTML = `<div class="pl-title">${it.title}</div><div style="display:flex;gap:6px"><button class="btn" onclick="cueToDeck('left','${it.id}')">L</button><button class="btn" onclick="cueToDeck('right','${it.id}')">R</button><button class="btn" onclick="removeFromPlaylist('${it.id}')">üóëÔ∏è</button></div>`;
    box.appendChild(row);
  });
}
function removeFromPlaylist(id){ 
    playlist = playlist.filter(x=>x.id!==id); 
    renderPlaylist(); 
    if (playlist.length === 0) fetchRelatedVideosFromPlaylist(); 
}

const relatedToggleBtn = document.getElementById('relatedToggleBtn');
if (relatedToggleBtn) {
    relatedToggleBtn.addEventListener('click', () => {
        autoFetchRelated = !autoFetchRelated;
        relatedToggleBtn.textContent = `Auto-Fetch: ${autoFetchRelated ? 'ON' : 'OFF'}`;
        relatedToggleBtn.style.color = autoFetchRelated ? 'var(--accent)' : 'var(--warn)';
        if (autoFetchRelated) fetchRelatedVideosFromPlaylist();
    });
}

async function fetchRelatedVideosFromPlaylist() {
    if (!autoFetchRelated) return; 
    const grid = document.getElementById('relatedVideosGrid');
    if(!apiKeys.length) return;
    
    if(!playlist.length) {
        grid.innerHTML = '<p style="padding:10px; color:var(--muted)">Loading Indian Music...</p>';
        showingDefaultMusic = true;
        renderedRelatedIds.clear();
        try {
            const res = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&q=Latest+Trending+Indian+Songs&maxResults=10&relevanceLanguage=hi&key=${apiKeys[0]}`);
            const data = await res.json();
            const videoIds = data.items.map(it => it.id.videoId).join(',');
            const vRes = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet,contentDetails&id=${videoIds}&key=${apiKeys[0]}`);
            const vData = await vRes.json();
            grid.innerHTML = ''; 
            renderRelatedVideos(vData.items, false);
        } catch (e) { grid.innerHTML = '<p style="padding:10px; color:var(--muted)">Unable to load music.</p>'; }
        return;
    }
    
    if (showingDefaultMusic) {
        grid.innerHTML = '';
        renderedRelatedIds.clear();
        showingDefaultMusic = false;
    }

    const latestTitle = playlist[0].title;
    let cleanQuery = latestTitle.split(/[\(\[\|-]/)[0].trim();
    if(cleanQuery.length < 3) cleanQuery = latestTitle;

    try {
        const res = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&q=${encodeURIComponent(cleanQuery + " song")}&maxResults=5&key=${apiKeys[0]}`);
        const data = await res.json();
        let newVideoIds = [];
        if(data.items) {
            data.items.forEach(it => {
                const vidId = it.id.videoId;
                if (!renderedRelatedIds.has(vidId) && !playlist.find(p => p.id === vidId)) {
                    newVideoIds.push(vidId);
                }
            });
        }
        if(newVideoIds.length > 0) {
            const vRes = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet,contentDetails&id=${newVideoIds.slice(0, 4).join(',')}&key=${apiKeys[0]}`);
            const vData = await vRes.json();
            renderRelatedVideos(vData.items, true); 
        }
    } catch(e) { console.error("Error fetching related:", e); }
}

function renderRelatedVideos(items, prepend = false){
  const grid = document.getElementById('relatedVideosGrid'); 
  items.forEach(it => {
    const sn = it.snippet, id = it.id;
    renderedRelatedIds.add(id); 
    const card = document.createElement('div'); card.className='card';
    card.innerHTML = `
      <div class="thumb-wrapper">
        <img src="${sn.thumbnails.medium.url}">
        <div class="duration-badge">${parseDuration(it.contentDetails.duration)}</div>
      </div>
      <div class="meta"><h4>${escapeHtml(sn.title)}</h4><div class="small">${escapeHtml(sn.channelTitle)}</div></div>
      <div class="actions">
        <button class="btn" onclick="cueToDeck('left','${id}')">Left</button>
        <button class="btn" onclick="cueToDeck('right','${id}')">Right</button>
        <button class="btn" onclick="addToPlaylist({id:'${id}',title:\`${escapeHtml(sn.title)}\`})">+ Playlist</button>
      </div>`;
    if (prepend) grid.insertBefore(card, grid.firstChild); 
    else grid.appendChild(card);
  });
  while(grid.children.length > 24) grid.removeChild(grid.lastChild);
}
</script>
</body>
</html>
